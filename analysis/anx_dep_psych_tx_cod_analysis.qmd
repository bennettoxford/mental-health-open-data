---
title: "Codelist analysis for psychological support and treatment for anxiety disorders and depression"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
editor: source
---

# Overview 

This document describes the coding patterns for psychological support and therapies for anxiety disorders and depression in English primary care EHR.

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true

# Load relevant libraries
library(opencodecounts)
library(here)
library(tidyverse)
library(scales)
library(gt)
library(stringr)
conflicted::conflicts_prefer(dplyr::filter)

source(here("lib", "functions", "fun_tables.R"))
source(here("lib", "functions", "fun_data.R"))
source(here("lib", "functions", "fun_figures.R"))
```

```{r}
#| label: load-codelists
#| echo: false
#| message: false
#| warning: false

# Load codelist
psych_tx_depr_anx_cod <- get_codelist(
  "user/Kunle_Oreagba/psychological-therapies-coding-for-anxiety-and-depression/6a9bc643"
)

# Get data for both codelists and extract semantic tag
psych_tx_depr_anx_usage <- snomed_usage |>
  filter(snomed_code %in% c(psych_tx_depr_anx_cod$code)) |>
  mutate(
    semantic_tag = extract_semantic_tag(description),
    description_short = strip_semantic_tag(description)
  ) |>
  select(
    start_date,
    end_date,
    snomed_code,
    description,
    usage,
    description_short,
    semantic_tag
  )

# Use the most recent description for all codes
psych_tx_depr_anx_usage <- psych_tx_depr_anx_usage |>
  group_by(snomed_code) %>%
  arrange(desc(end_date), .by_group = TRUE) %>%
  mutate(description_short = first(description_short)) %>%
  ungroup() |>
  arrange(desc(end_date), snomed_code)

psych_tx_depr_anx_usage <- psych_tx_depr_anx_usage |>
  filter(!semantic_tag %in% c("occupation", "observable entity"))

```

## Preliminary Analysis Objectives 

Preliminary objectives of the analysis include to:

- Describe the total usage of anxiety disorders and psychological therapy codes over the study period (1st August 2011 to 31st July 2024)
- Identify the most frequently used psychological therapy codes in English Primary care 
- Examine pattern of code usage by:
  - Referral or signposting codes vs codes indicating actual delivery of therapy
  - High-intensity vs low-intensity psychological therapy codes
  - Therapy indication, including specific codes for anxiety disorders, depression and cross-cutting codes


## Results 

### Table

```{r}
#| label: tab-top3-psych-tx-sem-tag-anx-dep
#| echo: false
#| message: false
#| warning: false

df_top3_psych_tx_sem_tag_anx_dep_usage <- psych_tx_depr_anx_usage |>
  group_by(snomed_code) |>
  mutate(total_usage = sum(usage)) |>
  select(
    snomed_code,
    description_short,
    semantic_tag,
    total_usage
  ) |>
  distinct(snomed_code, .keep_all = TRUE) |>
  ungroup() |>
  mutate(ratio_usage = total_usage / sum(total_usage)) |>
  group_by(semantic_tag) |>
  slice_max(order_by = total_usage, n = 3) |>
  arrange(semantic_tag, desc(total_usage))

description_dict <- c(
  "Referral to improving access to psychological therapies programme" = "Referral to IAPT",
  "Referral to improving access to psychological therapies programme declined" = "Referral to IAPT declined",
  "Self-referral to Improving Access to Psychological Therapies programme" = "Self-referral to IAPT",
  "Referral to Improving Access to Psychological Therapies programme offered" = "Referral to IAPT offered"
)

df_top3_psych_tx_sem_tag_anx_dep_usage <- df_top3_psych_tx_sem_tag_anx_dep_usage |>
  mutate(
    semantic_tag = str_to_sentence(semantic_tag),
    semantic_tag = case_when(
      semantic_tag == "Regime/therapy" ~ "Regime/Therapy",
      TRUE ~ semantic_tag
    ),
    description_short = recode(description_short, !!!description_dict)
  )


tab_top3_psych_tx_sem_tag_anx_dep_usage <- df_top3_psych_tx_sem_tag_anx_dep_usage |>
  gt() |>
  cols_label(
    snomed_code = "SNOMED code",
    description_short = "Description",
    semantic_tag = "Semantic tag",
    total_usage = "Usage",
    ratio_usage = "%"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) |>
  cols_align(
    align = "left",
    columns = snomed_code
  ) |>
  tab_style(
    style = list(
      cell_text(font = "Courier New")
    ),
    locations = cells_body(columns = snomed_code)
  ) |>
  fmt_number(total_usage, decimals = 0) |>
  fmt_percent(
    columns = c(ratio_usage),
    decimals = 1
  ) |>
  tab_footnote(
    footnote = "IAPT = Improving Access to Psychological Therapies programme.",
    locations = cells_column_labels(columns = description_short)
  ) |>
  tab_footnote(
    footnote = "Percentage usage across all codes.",
    locations = cells_column_labels(columns = ratio_usage)
  )

gtsave(
  tab_top3_psych_tx_sem_tag_anx_dep_usage,
  here(
    "output",
    "tables",
    "cod_analysis",
    "psych_tx",
    "tab_top3_psych_tx_sem_tag_anx_dep.png"
  )
)

tab_top3_psych_tx_sem_tag_anx_dep_usage
```

### Figure


```{r}
#| label: fig-total-trends
#| echo: false
#| fig-cap: "Yearly counts of most used codes for psychological therapies for anxiety disorders and depression from 2011/12 to 2023/24."
#| fig-height: 4
#| fig-width: 8
#| warning: false

scale_x_date_breaks <- unique(psych_tx_depr_anx_usage$end_date)


top_psych_tx_codes <- psych_tx_depr_anx_usage |>
  filter(semantic_tag == "regime/therapy") |>
  group_by(snomed_code) |>
  mutate(total_usage = sum(usage)) |>
  ungroup() |>
  select(snomed_code, total_usage) |>
  distinct() |>
  slice_max(order_by = total_usage, n = 4) |>
  pull(snomed_code)

# df_top_psych_tx_anx_dep_usage <-
df_fig_psych_tx_depr_anx_usage <- psych_tx_depr_anx_usage |>
  filter(snomed_code %in% top_psych_tx_codes) |>
  mutate(
    semantic_tag = case_when(
      semantic_tag == "Regime/therapy" ~ "Regime/Therapy",
      TRUE ~ semantic_tag
    )
  )

fig_psych_tx_depr_anx_usage <- df_fig_psych_tx_depr_anx_usage |>
  ggplot(
    aes(
      y = usage,
      x = end_date,
      colour = description_short,
      shape = description_short
    )
  ) +
  geom_line(alpha = 0.2) +
  geom_point(size = 2) +
  labs(
    title = NULL,
    x = "End date of yearly time interval",
    y = NULL,
    colour = NULL,
    shape = NULL
  ) +
  scale_x_date(
    breaks = scale_x_date_breaks,
    labels = scales::label_date("%b\n%Y")
  ) +
  scale_y_continuous(
    labels = label_number(accuracy = 1),
    limits = c(0, NA)
  ) +
  theme_bw() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_colour_viridis_d(end = .8) +
  guides(
    colour = guide_legend(ncol = 2, byrow = TRUE),
    shape = guide_legend(ncol = 2, byrow = TRUE)
  )


ggsave(
  filename = here(
    "output",
    "figures",
    "cod_analysis",
    "psych_tx",
    "fig_psych_tx_depr_anx.png"
  ),
  fig_psych_tx_depr_anx_usage,
  height = 4,
  width = 8
)

fig_psych_tx_depr_anx_usage
```