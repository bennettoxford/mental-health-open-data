---
title: "Codelist development for and anxiety disorders and depression diagnoses"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
      - text: AMPS 2023/4
        href: https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24
editor: source
---

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

library(opencodecounts) 
library(tidyverse)
library(scales)
library(gt)
library(here)
library(scales)
library(ggforce)
library(ggokabeito)

source(here("lib", "functions", "fun_tables.R"))
source(here("lib", "functions", "fun_data.R"))
source(here("lib", "functions", "fun_figures.R"))
```

```{r}
#| label: load-codelists
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

# Diagnosis codes

depr_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205"
)

anx_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205"
)

gad_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/gad/1b8281dc"
)

cmhcnos_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/cmhc-nos/02730ea7/"
)

ocd_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/ocd/633767f6/"
)

depression_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/depression/5054283c/"
)

pd_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/pd/3744b507/"
)

phobia_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/phobia/1e3541d2/"
)

ptsd_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/opensafely/posttraumatic-stress-disorder-ptsd/168e7933/"
)

# Resolved codes
dep_res_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depres_cod/20250627/"
)

anx_res_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxres_cod/20250627/"
)

depression_resolved_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/depression_resolved/1d6e8e43/"
)

pd_resolved_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/pd_resolved/6b4fa7d8/"
)

anxiety_resolved_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/user/milanwiedemann/anxiety_resolved/045f1b0e/"
)

```

# Overview

This report assesses the suitability of NHS England Primary Care Domain Reference Sets for identifying diagnoses of common mental health conditions, specifically anxiety diagnoses and depression, and compares them with codelists constructed to match the definitions used in the [Adult Psychiatric Morbidity Survey: Survey of Mental Health and Wellbeing, England, 2023/4](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24).

The analysis proceeds in two stages. First, the coverage and usage of the NHS Refsets are assessed using data from the NHS England SNOMED Code Usage in Primary Care dataset. Second, condition-specific codelists are constructed to mirror APMS diagnostic definitions, and usage patterns of these lists are evaluated over time.

# NHS Primary Care Refsets

The [Primary Care Domain Refset](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/primary-care-domain-reference-set-portal) contain codelist for *anxiety* and *depression* diagnostic ([`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/),[`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)) and resolved ([`anx_res_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxres_cod/20250627/),[`dep_res_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depres_cod/20250627/)) codes. 

## Diagnosis

### Analysis of codelists

The below figure shows the coding of anxiety disorders and depression diagnoses, as specified in the NHS Primary Care Domain Refsets ([`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/), [`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)).


```{r}
#| label: fig-anx-dep-cod-trends
#| fig-cap: "Yearly counts of anxiety disorder and depression diagnoistic codes as specified in the NHS Primary Care Domain Refsets."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

anx_cod_depr_cod_usage <- snomed_usage |> 
  mutate(
    depr_cod = snomed_code %in% depr_cod$code,
    anx_cod = snomed_code %in% anx_cod$code
    ) |> 
  pivot_longer(
    cols = c(depr_cod, anx_cod),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_depr_anx_cod_trends <- anx_cod_depr_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c("depr_cod", "anx_cod"), 
    labels = c("Depression diagnostic codes", "Anxiety diagnostic codes"))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.2) +
    geom_point() +
    labs(
      title = "Yearly counts of anxiety disorder and depression diagnoistic codes",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_colour_viridis_d(end = .8)

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_depr_anx_cod_trends.png"),
  fig_depr_anx_cod_trends,
  height = 4,
  width = 8
)

fig_depr_anx_cod_trends
```

### Analysis of individual codes

```{r}
#| label: overlap-refset-counts
#| message: false
#| warning: false

overlap <- intersect(depr_cod$code, anx_cod$code)

snomed_usage |> 
  filter(snomed_code %in% overlap) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  create_table_sem_tag(
    title = md("Codes appearing in both the NHS Refsets for depression and anxiety diagnoses"),
    subtitle = "Timeframe: August 2011 to July 2024"
  ) |> 
  cols_hide(ratio_usage)
```

::: {.panel-tabset}

#### Depression

```{r}
#| label: calc-depr-cod-counts
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

```

This table shows the 20 most used codes covering `r percent(sum(depr_cod_counts$ratio_usage), accuracy = 0.01)` of the total code usage of the codelist.
The full list of included codes is avilable on OpenCodelists, see [`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/).

```{r}
#| label: tab-depr-cod-counts
#| message: false
#| warning: false

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("*Depression* diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depr_cod_usage.png")
  )

tab_depr_cod_counts
```

#### Anxiety disorders

```{r}
#| label: calc-anx-cod-counts
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

anx_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anx_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

```

This table shows the 20 most used codes covering `r percent(sum(anx_cod_counts$ratio_usage), accuracy = 0.01)` of the total code usage of the codelist.
The full list of included codes is avilable on OpenCodelists, see [`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/).

```{r}
#| label: tab-anx-cod-counts
#| message: false
#| warning: false

# Display formatted table
tab_anx_cod_counts <- anx_cod_counts |>
  create_table_sem_tag(
    title = md("*Anxiety* diagnosis codes (`anx_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anx_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anx_cod_usage.png")
  )

tab_anx_cod_counts
```

:::

## Resolved

### Analysis of codelists

```{r}
#| label: fig-nhsrefset-res-cod-trends
#| fig-cap: "Yearly counts of resolved codes as specified by NHS Refsets."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

nhsrefset_res_cod_usage <- snomed_usage |> 
  mutate(
    anx_res = snomed_code %in% anx_res_cod$code,
    dep_res = snomed_code %in% dep_res_cod$code
    ) |> 
  pivot_longer(
    cols = c(
      anx_res,
      dep_res
    ),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_nhsrefset_res_cod_trends <- nhsrefset_res_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c(
      "anx_res",
      "dep_res"
    ),
    labels = c(
      "Anxiety disorder resolved",
      "Depression resolved"
    ))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.4) +
    geom_point(size = 2) +
    labs(
      title = "Yearly counts of resolved codes as specified by NHS Refsets",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_color_okabe_ito()

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_nhsrefset_res_cod_trends.png"),
  fig_nhsrefset_res_cod_trends,
  height = 4,
  width = 8
)

fig_nhsrefset_res_cod_trends
```

### Analysis of individual codes

::: {.panel-tabset}

#### Anxiety

- **OpenCodelists**: [Anxiety disorder resolved codes (`anx_res_cod`)](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxres_cod/20250627/)

```{r}
#| label: tab-anx-res-cod-counts
#| message: false
#| warning: false

anx_res_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anx_res_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_anx_res_cod_counts <- anx_res_cod_counts |>
  create_table_sem_tag(
    title = md("*Anxiety* disorder resolved codes (`anx_res_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anx_res_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anx_res_nhsrefset_cod_usage.png")
  )

tab_anx_res_cod_counts
```

#### Depression

- **OpenCodelists**: [Depression dignosis resolved codes (`depres_cod`)](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depres_cod/20250627/)

```{r}
#| label: tab-dep-res-cod-counts
#| message: false
#| warning: false

dep_res_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% dep_res_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_dep_res_cod_counts <- dep_res_cod_counts |>
  create_table_sem_tag(
    title = md("*Depression* dignosis resolved (`dep_res_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_dep_res_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_dep_res_nhsrefset_cod_usage.png")
  )

tab_dep_res_cod_counts
```

:::

# APM Survey 

In the [Adult Psychiatric Morbidity Survey: Survey of Mental Health and Wellbeing, England, 2023/4](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/methods) the following mental health conditions are assessed in [Chapter 1: Common mental health conditions](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/common-mental-health-conditions) and [Chapter 3: Posttraumatic stress disorder](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/posttraumatic-stress-disorder) of the survey, see [Appendix A: Assessment of disorders](https://digital.nhs.uk/binaries/content/assets/website-assets/publications/apms-2023-4/appendix-a---assessment-of-disorders.pdf) for more details.

```{r}

condition_names <- list(
  gad = "Generalised anxiety disorder (GAD)",
  cmhc_nos = "Common mental health conditions not otherwise specified (CMHC-NOS)",
  ocd = "Obsessive and compulsive disorder (OCD)",
  dep = "Depressive episode",
  pd = "Panic disorder (PD)",
  phobia = "Phobia",
  ptsd = "Posttraumatic stress disorder (PTSD)"
)

measures_mental_health_conditions <- list(
  gad = list(
    condition = "Generalised anxiety disorder (GAD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  cmhc_nos = list(
    condition = "Common mental health conditions not otherwise specified (CMHC-NOS)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ocd = list(
    condition = "Obsessive and compulsive disorder (OCD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  dep = list(
    condition = "Depressive episode",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  pd = list(
    condition = "Panic disorder",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  phobia = list(
    condition = "Phobia",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ptsd = list(
    condition = "Posttraumatic stress disorder (PTSD)",
    diagnostic_status = "Screen positive",
    classification_system = "DSM-IV",
    assessment_tool = "PTSD Check List",
    survey_phase = "1",
    reference_period = "Past week"
  )
)

df_measures_mental_health_conditions <- map_dfr(measures_mental_health_conditions, ~.x, .id = "condition_tag")

gt(df_measures_mental_health_conditions) |> 
  cols_label(
    condition = "Condition",
    diagnostic_status = "Diagnostic status",
    classification_system = "Classification system",
    assessment_tool = "Assessment tool",
    survey_phase = "Survey phase",
    reference_period = "Reference period"
  ) |> 
  cols_hide(
    c(
      condition_tag,
      diagnostic_status,
      survey_phase,
      reference_period
      )
    )
```

## Diagnosis

### Analysis of codelists

```{r}
#| label: fig-amps-cod-trends
#| fig-cap: "Yearly counts of diagnoistic codes following AMPS methods."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

amps_cod_usage <- snomed_usage |> 
  mutate(
    gad_cod = snomed_code %in% gad_cod$code,
    cmhcnos_cod = snomed_code %in% cmhcnos_cod$code,
    ocd_cod = snomed_code %in% ocd_cod$code,
    depression_cod = snomed_code %in% depression_cod$code,
    pd_cod = snomed_code %in% pd_cod$code,
    phobia_cod = snomed_code %in% phobia_cod$code,
    ptsd_cod = snomed_code %in% ptsd_cod$code
    ) |> 
  pivot_longer(
    cols = c(
      gad_cod,
      cmhcnos_cod,
      ocd_cod,
      depression_cod,
      pd_cod,
      phobia_cod,
      ptsd_cod
    ),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_amps_cod_trends <- amps_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c(
      "gad_cod",
      "cmhcnos_cod",
      "ocd_cod",
      "depression_cod",
      "pd_cod",
      "phobia_cod",
      "ptsd_cod"
    ),
    labels = c(
      "GAD",
      "CMHC-NOS",
      "OCD",
      "Depression",
      "PD",
      "Phobia",
      "PTSD"
    ))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.4) +
    geom_point(size = 2) +
    labs(
      title = "Yearly counts of diagnoistic codes following AMPS methods",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_color_okabe_ito()

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_amps_cod_trends.png"),
  fig_amps_cod_trends,
  height = 4,
  width = 8
)

fig_amps_cod_trends
```

```{r}
#| label: fig-amps-cod-trends-zoom
#| fig-cap: "Yearly counts of diagnoistic codes following AMPS methods. The y axis of the left panel is zoomed into codelists with low counts."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

fig_amps_cod_trends_zoom <- fig_amps_cod_trends +
    facet_zoom(ylim = c(30000, 200000), zoom.size = 3) +
    scale_x_date(
      breaks = c(
        as.Date("2012-07-31"),
        as.Date("2016-01-01"),
        as.Date("2020-01-01"),
        as.Date("2024-07-31")
      ),
      labels = label_date("%Y")
    )

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_amps_cod_trends_zoom.png"),
  fig_amps_cod_trends_zoom,
  height = 4,
  width = 8
)

fig_amps_cod_trends_zoom
```

### Analysis of individual codes

::: {.panel-tabset}

#### GAD

- **ICD-10 codes**: `F41.1` (Generalised anxiety disorder).
- **OpenCodelists**: [Generalised anxiety disorder diagnostic codes](https://www.opencodelists.org/codelist/user/milanwiedemann/gad/1b8281dc)

```{r}
#| label: tab-gad-cod-counts
#| message: false
#| warning: false

gad_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% gad_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_gad_cod_counts <- gad_cod_counts |>
  create_table_sem_tag(
    title = md("Generalised Anxiety Disorder"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_gad_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_gad_usage.png")
  )

tab_gad_cod_counts
```

#### CMHC-NOS

- **ICD-10 codes**: `F41.2` (Mixed anxiety and depressive disorder).
- **OpenCodelists**: [Common mental health conditions not otherwise specified](https://www.opencodelists.org/codelist/user/milanwiedemann/cmhc-nos/02730ea7/)

```{r}
#| label: tab-cmhcnos-cod-counts
#| message: false
#| warning: false

cmhcnos_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% cmhcnos_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_cmhcnos_cod_counts <- cmhcnos_cod_counts |>
  create_table_sem_tag(
    title = md("CMHC-NOS diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_cmhcnos_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_cmhcnos_cod_usage.png")
  )

tab_cmhcnos_cod_counts
```

#### OCD

- **ICD-10 codes**: `F42` (Obsessive-compulsive disorder).
- **OpenCodelists**: [Obsessive-compulsive disorder diagnostic codes](https://www.opencodelists.org/codelist/user/milanwiedemann/ocd/633767f6/)

```{r}
#| label: tab-depre-ocd-counts
#| message: false
#| warning: false

ocd_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% ocd_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_ocd_cod_counts <- ocd_cod_counts |>
  create_table_sem_tag(
    title = md("Obsessive-compulsive disorder diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_ocd_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_ocd_cod_usage.png")
  )

tab_ocd_cod_counts
```

#### Depression

- **ICD-10 codes**: `F32.00` (Mild depressive episode without somatic symptoms) and `F32.01` (Mild depressive episode with somatic symptoms) were grouped to produce mild depressive episode (i.e. with or without somatic symptoms).
`F32.10` (Moderate depressive episode without somatic symptoms) and `F32.11` (Moderate depressive episode with somatic symptoms) were similarly grouped to produce moderate depressive episode. 
Mild depressive episode, moderate depressive episode and severe depressive episode were then combined to produce the final category of depressive episode.
- **OpenCodelists**: [Depression diagnostic codes](https://www.opencodelists.org/codelist/user/milanwiedemann/depression/5054283c/)

```{r}
#| label: tab-depre-cod-counts
#| message: false
#| warning: false

depression_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depression_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depression_cod_counts <- depression_cod_counts |>
  create_table_sem_tag(
    title = md("Depression diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depression_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depression_cod_usage.png")
  )

tab_depression_cod_counts
```

#### PD

- **ICD-10 codes**: `F41.0` Panic disorder
- **OpenCodelists**: [Panic disorder diagnostic codes](https://www.opencodelists.org/codelist/user/milanwiedemann/pd/3744b507/)

```{r}
#| label: tab-pd-cod-counts
#| message: false
#| warning: false

pd_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% pd_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_pd_cod_counts <- pd_cod_counts |>
  create_table_sem_tag(
    title = md("Panic Disorder (PD) diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_pd_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_pd_cod_usage.png")
  )

tab_pd_cod_counts
```

#### Phobia

- **ICD-10 codes**: `F40.00` (Agoraphobia without panic disorder), `F40.01` (Agoraphobia with panic disorder), `F40.1` (Social phobias), and `F40.2` (Specific (isolated) phobias), were combined into one category of phobia.
- **OpenCodelists**: [Phobia diagnostic codes](https://www.opencodelists.org/codelist/user/milanwiedemann/phobia/1e3541d2/)

```{r}
#| label: tab-cmh-phobia-cod-counts
#| message: false
#| warning: false

phobia_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% phobia_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_phobia_cod_counts <- phobia_cod_counts |>
  create_table_sem_tag(
    title = md("Phobia diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_phobia_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_phobia_cod_usage.png")
  )

tab_phobia_cod_counts
```

#### PTSD

- **ICD-10 codes**: `F43.1` (Post-traumatic stress disorder), assessed using DSM-IV symptoms of PTSD.
- **OpenCodelists**: [PTSD diagnostic codes](https://www.opencodelists.org/codelist/opensafely/posttraumatic-stress-disorder-ptsd/168e7933/)

```{r}
#| label: tab-cmh-ptsd-cod-counts
#| message: false
#| warning: false

ptsd_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% ptsd_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_ptsd_cod_counts <- ptsd_cod_counts |>
  create_table_sem_tag(
    title = md("Posttraumatic Stress Disorder (PTSD) diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_ptsd_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_ptsd_cod_usage.png")
  )

tab_ptsd_cod_counts
```

:::

## Resolved

### Analysis of codelists

```{r}
#| label: fig-amps-res-cod-trends
#| fig-cap: "Yearly counts of resolved codes following AMPS methods."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

amps_res_cod_usage <- snomed_usage |> 
  mutate(
    anxiety_resolved = snomed_code %in% anxiety_resolved_cod$code,
    pd_resolved = snomed_code %in% pd_resolved_cod$code,
    depression_resolved = snomed_code %in% depression_resolved_cod$code,
    ) |> 
  pivot_longer(
    cols = c(
      anxiety_resolved,
      pd_resolved,
      depression_resolved
    ),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_amps_res_cod_trends <- amps_res_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c(
      "anxiety_resolved",
      "pd_resolved",
      "depression_resolved"
    ),
    labels = c(
      "Anxiety disorder resolved",
      "Panic disorder resolved",
      "Depression resolved"
    ))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.4) +
    geom_point(size = 2) +
    labs(
      title = "Yearly counts of resolved codes following AMPS methods",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_color_okabe_ito()

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_amps_res_cod_trends.png"),
  fig_amps_res_cod_trends,
  height = 4,
  width = 8
)

fig_amps_res_cod_trends
```

### Analysis of individual codes

::: {.panel-tabset}

#### Anxiety

- **OpenCodelists**: [Anxiety disorder resolved codes](https://www.opencodelists.org/codelist/user/milanwiedemann/anxiety_resolved/045f1b0e/)

```{r}
#| label: tab-anxiety-res-cod-counts
#| message: false
#| warning: false

anxiety_res_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anxiety_resolved_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_anxiety_res_cod_counts <- anxiety_res_cod_counts |>
  create_table_sem_tag(
    title = md("Anxiety disorder resolved codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anxiety_res_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anxiety_res_usage.png")
  )

tab_anxiety_res_cod_counts
```

#### Depression

- **OpenCodelists**: [Depression dignosis resolved or full remission codes](https://www.opencodelists.org/codelist/user/milanwiedemann/depression_resolved/1d6e8e43/)

```{r}
#| label: tab-depression-res-cod-counts
#| message: false
#| warning: false

depression_res_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depression_resolved_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depression_res_cod_counts <- depression_res_cod_counts |>
  create_table_sem_tag(
    title = md("Depression dignosis resolved or full remission codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depression_res_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depression_res_cod_usage.png")
  )

tab_depression_res_cod_counts
```

#### Panic disorder

- **OpenCodelists**: [Panic disorder resolved or full remission codes](https://www.opencodelists.org/codelist/user/milanwiedemann/pd_resolved/6b4fa7d8/)

```{r}
#| label: tab-pd-res-ocd-counts
#| message: false
#| warning: false

pd_res_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% pd_resolved_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_pd_res_cod_counts <- pd_res_cod_counts |>
  create_table_sem_tag(
    title = md("Panic disorder resolved or full remission codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_pd_res_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_pd_res_cod_usage.png")
  )

tab_pd_res_cod_counts
```

:::
