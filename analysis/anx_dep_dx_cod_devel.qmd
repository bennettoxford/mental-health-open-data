---
title: "Codelist development for and anxiety disorders and depression diagnoses"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
execute:
  cache: true
editor: source
---

# Load packages

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true

library(opencodecounts) 
library(tidyverse)
library(scales)
library(gt)
library(here)

source(here("lib", "fun_tables.R"))
source(here("lib", "fun_data.R"))
source(here("lib", "fun_figures.R"))
```

# NHS Primary Care Refsets

Load [Primary Care Domain Refset](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/primary-care-domain-reference-set-portal) codelists from [OpenCodelists](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/) for anxiety diagnostic codes ([`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/)) and depression diagnostic codes ([`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)). 
We search all SNOMED CT descriptions for terms that we want to review for possible inclusion in the existing codelists (e.g., "depression", "anxiety").


```{r}
#| label: load-codelists

depr_cod <- get_codelist(
  "nhsd-primary-care-domain-refsets/depr_cod/20241205"
)

anx_cod <- get_codelist(
  "nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205"
)

# Remove all codes that are in our codelist
snomed_usage_without_depr_cod <- snomed_usage |> 
  filter(!snomed_code %in% depr_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_depr_cod_review <- snomed_usage_without_depr_cod |> 
  filter(str_detect(description, "depression"))

# Remove all codes that are in our codelist
snomed_usage_without_anx_cod <- snomed_usage |> 
  filter(!snomed_code %in% anx_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_anx_cod_review <- snomed_usage_without_anx_cod |> 
  filter(str_detect(description, "anxiety"))
```

## Total code usage

::: {.panel-tabset}

### Depression

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the depression codelist.
There were *n* = `r nrow(snomed_usage_without_depr_cod_review)` codes with the term `"depression"` in their description that are not in our codelist.
These codes could be reviewed by a clinical expert to determine if they should be included here.
For now, we will assume that they are not relevant as they have not been included in the NHSD refset.


```{r}
#| label: tab-depr-cod-counts
#| message: false
#| warning: false

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depr_cod_usage.png")
  )

tab_depr_cod_counts
```

### Anxiety disorders

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the anxiety codelist.
There were *n* = `r nrow(snomed_usage_without_anx_cod_review)` codes with the term `"anxiety"` in their description that are not in our codelist. These codes could be reviewed by a clinical expert to determine if they should be included here. For now, we will assume that they are not relevant as they have not been included in the NHSD refset.


```{r}
#| label: tab-anx-cod-counts
#| message: false
#| warning: false

anx_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anx_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_anx_cod_counts <- anx_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 anxiety diagnosis codes (`anx_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anx_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anx_cod_usage.png")
  )

tab_anx_cod_counts
```

:::

## Trends over time

The below figure shows the coding of anxiety disorders and depression diagnoses, as specified in the NHS Primary Care Domain Refsets ([anx_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/), [depr_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)).


```{r}
#| label: fig-anx-dep-cod-trends
#| fig-cap: "Yearly counts of anxiety disorder and depression diagnoistic codes."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

anx_cod_depr_cod_usage <- snomed_usage |> 
  mutate(
    depr_cod = snomed_code %in% depr_cod$code,
    anx_cod = snomed_code %in% anx_cod$code
    ) |> 
  pivot_longer(
    cols = c(depr_cod, anx_cod),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_depr_anx_cod_trends <- anx_cod_depr_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c("depr_cod", "anx_cod"), 
    labels = c("Depression diagnostic codes", "Anxiety diagnostic codes"))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.2) +
    geom_point() +
    labs(
      title = "Yearly counts of anxiety disorder and depression diagnoistic codes",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_colour_viridis_d(end = .8)

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_depr_anx_cod_trends.png"),
  fig_depr_anx_cod_trends,
  height = 4,
  width = 8
)

fig_depr_anx_cod_trends
```

# Survey

[Methods - Adult Psychiatric Morbidity Survey: Survey of Mental Health and Wellbeing, England, 2023/4](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/method)

```{r}

condition_names <- list(
  gad = "Generalised anxiety disorder (GAD)",
  cmhc_nos = "Common mental health condition (CMHC) not otherwise specified (NOS)",
  ocd = "Obsessive and compulsive disorder (OCD)",
  dep = "Depressive episode",
  pd = "Panic disorder",
  phobia = "Phobia",
  ptsd = "Posttraumatic stress disorder (PTSD)"
)

measures_mental_health_conditions <- list(
  gad = list(
    condition = "Generalised anxiety disorder (GAD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  cmhc_nos = list(
    condition = "Common mental health condition (CMHC) not otherwise specified (NOS)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ocd = list(
    condition = "Obsessive and compulsive disorder (OCD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  dep = list(
    condition = "Depressive episode",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  pd = list(
    condition = "Panic disorder",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  phobia = list(
    condition = "Phobia",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ptsd = list(
    condition = "Posttraumatic stress disorder (PTSD)",
    diagnostic_status = "Screen positive",
    classification_system = "DSM-IV",
    assessment_tool = "PTSD Check List",
    survey_phase = "1",
    reference_period = "Past week"
  )
)

df_measures_mental_health_conditions <- map_dfr(mental_health_conditions, ~.x, .id = "condition_tag")

gt(df_measures_mental_health_conditions) |> 
  cols_label(
    condition = "Condition",
    diagnostic_status = "Diagnostic status",
    classification_system = "Classification system",
    assessment_tool = "Assessment tool",
    survey_phase = "Survey phase",
    reference_period = "Reference period"
  ) |> 
  cols_hide(condition_tag)
```


## Search terms 

```{r}

search_terms <- list(
  gad = c(
    "generalised anxiety",
    "generalized anxiety",
    "GAD",
    "anxiety disorder",
    "persistent anxiety",
    "excessive worry",
    "chronic anxiety"
  ),
  cmhc_nos = c(
    "mental disorder",
    "psychiatric disorder",
    "mental health condition",
    "psychological disorder",
    "behavioural disorder",
    "emotional disorder",
    "unspecified mental"
  ),
  ocd = c(
    "obsessive compulsive",
    "OCD",
    "obsession",
    "compulsion",
    "repetitive behaviour",
    "intrusive thought",
    "ritualistic behaviour"
  ),
  dep = c(
    "depression",
    "depressive episode",
    "major depression",
    "unipolar depression",
    "mood disorder",
    "depressive disorder",
    "melancholia",
    "dysthymia"
  ),
  pd = c(
    "panic disorder",
    "panic attack",
    "agoraphobia",
    "acute anxiety",
    "episodic anxiety"
  ),
  phobia = c(
    "phobia",
    "phobic disorder",
    "specific phobia",
    "social phobia",
    "agoraphobia",
    "fear disorder",
    "anxiety phobia"
  ),
  ptsd = c(
    "posttraumatic stress",
    "post-traumatic stress",
    "PTSD",
    "trauma disorder",
    "stress reaction",
    "acute stress",
    "combat stress"
  )
)


search_terms <- list(
  gad = c(
    "generalised anxiety",
    "chronic anxiety"
  ),
  ptsd = c(
    "posttraumatic stress",
    "combat stress"
  )
)

# Create smaller dataframe with unique SNOMED CT code/description mapping
snomed_code_desc <- snomed_usage |> 
  select(end_date, snomed_code, description) |> 
  group_by(snomed_code) |> 
  arrange(desc(end_date), .by_group = TRUE) |> 
  mutate(description = first(description)) |> 
  ungroup() |> 
  arrange(desc(end_date), snomed_code) |> 
  select(-end_date) |> 
  distinct()



create_category_regex_pattern <- function(category_terms) {
  str_c("(?i)", str_c(category_terms, collapse = "|"))
}

identify_matching_terms <- function(text, category_terms) {
  matches_term <- function(term) {
    str_detect(text, regex(term, ignore_case = TRUE))
  }
  
  category_terms[map_lgl(category_terms, matches_term)]
}

format_matching_terms <- function(text, category_terms) {
  matching_terms <- identify_matching_terms(text, category_terms)
  
  if (length(matching_terms) == 0) {
    return(NA_character_)
  }
  
  str_c(matching_terms, collapse = "; ")
}

add_category_columns <- function(matched_rows, category_name, category_terms) {
  matched_rows |>
    mutate(
      search_category = category_name,
      matching_term = map_chr(description, ~format_matching_terms(.x, category_terms)),
      .before = 1
    )
}

search_category <- function(data, category_name, category_pattern, category_terms) {
  matched_idx <- str_detect(data$description, category_pattern)
  
  if (!any(matched_idx)) {
    return(NULL)
  }
  
  data[matched_idx, ] |>
    add_category_columns(category_name, category_terms)
}

find_matching_codes <- function(data, search_terms) {
  patterns <- map(search_terms, create_category_regex_pattern)
  
  map_dfr(names(patterns), ~search_category(
    data,
    category_name = .x,
    category_pattern = patterns[[.x]],
    category_terms = search_terms[[.x]]
  ))
}


matching_codes_tibble <- find_matching_codes(snomed_code_desc, search_terms)

matching_codes_tibble |> 
  mutate(
    semantic_tag = extract_semantic_tag(description),
    description = strip_semantic_tag(description)
  )

matching_codes_tibble |> View()


extract_codes_by_category <- function(matching_codes_tibble) {
  matching_codes_tibble |>
    group_by(search_category) |>
    summarise(codes = list(snomed_code)) |>
    deframe()
}

codes_by_category <- extract_codes_by_category(matching_codes_tibble)
codes_by_category
```