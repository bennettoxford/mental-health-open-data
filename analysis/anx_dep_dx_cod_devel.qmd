---
title: "Codelist development for and anxiety disorders and depression diagnoses"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
execute:
  cache: true
editor: source
---

# Load packages

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true

library(opencodecounts) 
library(tidyverse)
library(scales)
library(gt)
library(here)

source(here("lib", "fun_tables.R"))
source(here("lib", "fun_data.R"))
source(here("lib", "fun_figures.R"))
```

# NHS Primary Care Refsets

Load [Primary Care Domain Refset](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/primary-care-domain-reference-set-portal) codelists from [OpenCodelists](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/) for anxiety diagnostic codes ([`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/)) and depression diagnostic codes ([`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)). 
We search all SNOMED CT descriptions for terms that we want to review for possible inclusion in the existing codelists (e.g., "depression", "anxiety").


```{r}
#| label: load-codelists

depr_cod <- get_codelist(
  "nhsd-primary-care-domain-refsets/depr_cod/20241205"
)

anx_cod <- get_codelist(
  "nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205"
)

# Remove all codes that are in our codelist
snomed_usage_without_depr_cod <- snomed_usage |> 
  filter(!snomed_code %in% depr_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_depr_cod_review <- snomed_usage_without_depr_cod |> 
  filter(str_detect(description, "depression"))

# Remove all codes that are in our codelist
snomed_usage_without_anx_cod <- snomed_usage |> 
  filter(!snomed_code %in% anx_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_anx_cod_review <- snomed_usage_without_anx_cod |> 
  filter(str_detect(description, "anxiety"))
```

## Total code usage

::: {.panel-tabset}

### Depression

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the depression codelist.
There were *n* = `r nrow(snomed_usage_without_depr_cod_review)` codes with the term `"depression"` in their description that are not in our codelist.
These codes could be reviewed by a clinical expert to determine if they should be included here.
For now, we will assume that they are not relevant as they have not been included in the NHSD refset.


```{r}
#| label: tab-depr-cod-counts
#| message: false
#| warning: false

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depr_cod_usage.png")
  )

tab_depr_cod_counts
```

### Anxiety disorders

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the anxiety codelist.
There were *n* = `r nrow(snomed_usage_without_anx_cod_review)` codes with the term `"anxiety"` in their description that are not in our codelist. These codes could be reviewed by a clinical expert to determine if they should be included here. For now, we will assume that they are not relevant as they have not been included in the NHSD refset.


```{r}
#| label: tab-anx-cod-counts
#| message: false
#| warning: false

anx_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anx_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_anx_cod_counts <- anx_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 anxiety diagnosis codes (`anx_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anx_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anx_cod_usage.png")
  )

tab_anx_cod_counts
```

:::

## Trends over time

The below figure shows the coding of anxiety disorders and depression diagnoses, as specified in the NHS Primary Care Domain Refsets ([anx_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/), [depr_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)).


```{r}
#| label: fig-anx-dep-cod-trends
#| fig-cap: "Yearly counts of anxiety disorder and depression diagnoistic codes."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

anx_cod_depr_cod_usage <- snomed_usage |> 
  mutate(
    depr_cod = snomed_code %in% depr_cod$code,
    anx_cod = snomed_code %in% anx_cod$code
    ) |> 
  pivot_longer(
    cols = c(depr_cod, anx_cod),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_depr_anx_cod_trends <- anx_cod_depr_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c("depr_cod", "anx_cod"), 
    labels = c("Depression diagnostic codes", "Anxiety diagnostic codes"))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.2) +
    geom_point() +
    labs(
      title = "Yearly counts of anxiety disorder and depression diagnoistic codes",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_colour_viridis_d(end = .8)

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_depr_anx_cod_trends.png"),
  fig_depr_anx_cod_trends,
  height = 4,
  width = 8
)

fig_depr_anx_cod_trends
```

# Survey

| Condition | Diagnostic status | Classification system | Assessment tool | Survey phase | Reference period |
|-----------|-------------------|----------------------|----------------|--------------|------------------|
| Generalised anxiety disorder (GAD) | Present to diagnostic criteria | International Statistical Classification of Diseases and Related Health Problems 10th Revision (ICD-10) (World Health Organization 1993) | Clinical Interview Schedule â€“ Revised (CIS-R) (Lewis et al. 1992) | 1 | Past week |
| Common mental health condition (CMHC) not otherwise specified (NOS) | Present to diagnostic | ICD-10 | CIS-R | 1 | Past week |
| Obsessive and compulsive disorder (OCD) | Present to diagnostic criteria | ICD-10 | CIS-R | 1 | Past week |
| Depressive episode | Present to diagnostic criteria | ICD-10 | CIS-R | 1 | Past week |
| Panic disorder | Present to diagnostic criteria | ICD-10 | CIS-R | 1 | Past week |
| Phobia | Present to diagnostic criteria | ICD-10 | CIS-R | 1 | Past week |
| Posttraumatic stress disorder (PTSD) | Screen positive | Diagnostic and Statistical Manual of Mental Disorders-IV (DSM-IV, American Psychiatric Association 1994) | PTSD Check List (Blanchard et al 1996) | 1 | Past week |


```{r}

search_terms <- list(
  gad = c(
    "generalised anxiety",
    "generalized anxiety",
    "GAD",
    "anxiety disorder",
    "persistent anxiety",
    "excessive worry",
    "chronic anxiety"
  ),
  cmhc_nos = c(
    "mental disorder",
    "psychiatric disorder",
    "mental health condition",
    "psychological disorder",
    "behavioural disorder",
    "emotional disorder",
    "unspecified mental"
  ),
  ocd = c(
    "obsessive compulsive",
    "OCD",
    "obsession",
    "compulsion",
    "repetitive behaviour",
    "intrusive thought",
    "ritualistic behaviour"
  ),
  dep = c(
    "depression",
    "depressive episode",
    "major depression",
    "unipolar depression",
    "mood disorder",
    "depressive disorder",
    "melancholia",
    "dysthymia"
  ),
  panic = c(
    "panic disorder",
    "panic attack",
    "agoraphobia",
    "acute anxiety",
    "episodic anxiety"
  ),
  phobia = c(
    "phobia",
    "phobic disorder",
    "specific phobia",
    "social phobia",
    "agoraphobia",
    "fear disorder",
    "anxiety phobia"
  ),
  ptsd = c(
    "posttraumatic stress",
    "post-traumatic stress",
    "PTSD",
    "trauma disorder",
    "stress reaction",
    "acute stress",
    "combat stress"
  )
)

# Create smaller dataframe with unique SNOMED CT code/description mapping
snomed_code_desc <- snomed_usage |> 
  select(end_date, snomed_code, description) |> 
  group_by(snomed_code) |> 
  arrange(desc(end_date), .by_group = TRUE) |> 
  mutate(description = first(description)) |> 
  ungroup() |> 
  arrange(desc(end_date), snomed_code) |> 
  select(-end_date) |> 
  distinct()

# Write function to find matching codes for multiple search terms
# THIS ONLY GETS THE CODES
find_matching_codes <- function(description_data, search_terms) {
 
 create_search_pattern <- function(terms) {
   paste0("\\b(", paste(terms, collapse = "|"), ")\\b")
 }
 
 find_matching_rows <- function(data, pattern) {
   grepl(pattern, data$description, ignore.case = TRUE)
 }
 
 extract_codes <- function(data, matches) {
   data$snomed_code[matches]
 }
 
 find_codes_for_terms <- function(description_data, terms) {
   pattern <- create_search_pattern(terms)
   matches <- find_matching_rows(description_data, pattern)
   extract_codes(description_data, matches)
 }
 
 map(search_terms, ~find_codes_for_terms(description_data, .x))
}

matching_codes <- find_matching_snomed_codes(snomed_code_desc, search_terms)
matching_codes

# THIS GETS THE CODES AND DESCRIPTIONS
find_matching_codes <- function(snomed_usage, search_terms) {
 
 create_search_pattern <- function(terms) {
   paste0("\\b(", paste(terms, collapse = "|"), ")\\b")
 }
 
 find_matching_rows <- function(data, pattern) {
   grepl(pattern, data$description, ignore.case = TRUE)
 }
 
 extract_codes_and_descriptions <- function(data, matches) {
   matched_data <- data[matches, ]
   setNames(matched_data$snomed_code, matched_data$description)
 }
 
 find_codes_for_terms <- function(snomed_data, terms) {
   pattern <- create_search_pattern(terms)
   matches <- find_matching_rows(snomed_data, pattern)
   extract_codes_and_descriptions(snomed_data, matches)
 }
 
 map(search_terms, ~find_codes_for_terms(snomed_usage, .x))
}

matching_codes_desc <- find_matching_snomed_codes(snomed_usage, search_terms)
matching_codes_desc

convert_to_tibble <- function(matching_codes) {
 map2_dfr(matching_codes, names(matching_codes), function(codes, category) {
   tibble(
     search_category = category,
     snomed_code = codes,
     description = names(codes)
   )
 })
}

matching_codes_tibble <- convert_to_tibble(matching_codes_desc)

df_psych_dx_terms <- matching_codes_tibble |> 
  mutate(
    semantic_tag = extract_semantic_tag(description),
    description = strip_semantic_tag(description)
  )

# NO IDEA WHY I NEED DIStiNCt HErE? 
# why are there multiple identical rows?
# This gets the df down from 1,699 to 242
df_psych_dx_terms <- df_psych_dx_terms |> 
  filter(semantic_tag == "disorder") |> 
  distinct()

df_psych_dx_terms |> 
  filter(search_category == "gad")
```