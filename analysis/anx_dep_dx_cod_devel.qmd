---
title: "Codelist development for and anxiety disorders and depression diagnoses"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
editor: source
---

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

library(opencodecounts) 
library(tidyverse)
library(scales)
library(gt)
library(here)

source(here("lib", "fun_search_terms.R"))
source(here("lib", "fun_tables.R"))
source(here("lib", "fun_data.R"))
source(here("lib", "fun_figures.R"))
```

# NHS Primary Care Refsets

Load [Primary Care Domain Refset](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/primary-care-domain-reference-set-portal) codelists from [OpenCodelists](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/) for anxiety diagnostic codes ([`anx_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/)) and depression diagnostic codes ([`depr_cod`](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)). 
We search all SNOMED CT descriptions for terms that we want to review for possible inclusion in the existing codelists (e.g., "depression", "anxiety").


```{r}
#| label: load-codelists

depr_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205"
)

anx_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205"
)

# Remove all codes that are in our codelist
snomed_usage_without_depr_cod <- snomed_usage |> 
  filter(!snomed_code %in% depr_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_depr_cod_review <- snomed_usage_without_depr_cod |> 
  filter(str_detect(description, "depression"))

# Remove all codes that are in our codelist
snomed_usage_without_anx_cod <- snomed_usage |> 
  filter(!snomed_code %in% anx_cod$code)

# Search for related codes (e.g., with "depression" in description) and review
snomed_usage_without_anx_cod_review <- snomed_usage_without_anx_cod |> 
  filter(str_detect(description, "anxiety"))
```

## Total code usage

::: {.panel-tabset}

### Depression

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the depression codelist.
There were *n* = `r nrow(snomed_usage_without_depr_cod_review)` codes with the term `"depression"` in their description that are not in our codelist.
These codes could be reviewed by a clinical expert to determine if they should be included here.
For now, we will assume that they are not relevant as they have not been included in the NHS refset.

```{r}
#| label: tab-depr-cod-counts
#| message: false
#| warning: false

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depr_cod_usage.png")
  )

tab_depr_cod_counts
```

### Anxiety disorders

The below table summarises the frequency of each code from 2011/12 to 2023/24 included in the anxiety codelist.
There were *n* = `r nrow(snomed_usage_without_anx_cod_review)` codes with the term `"anxiety"` in their description that are not in our codelist. These codes could be reviewed by a clinical expert to determine if they should be included here. For now, we will assume that they are not relevant as they have not been included in the NHS refset.

```{r}
#| label: tab-anx-cod-counts
#| message: false
#| warning: false

anx_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% anx_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_anx_cod_counts <- anx_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 anxiety diagnosis codes (`anx_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_anx_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_anx_cod_usage.png")
  )

tab_anx_cod_counts
```

:::

## Trends over time

The below figure shows the coding of anxiety disorders and depression diagnoses, as specified in the NHS Primary Care Domain Refsets ([anx_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/), [depr_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)).


```{r}
#| label: fig-anx-dep-cod-trends
#| fig-cap: "Yearly counts of anxiety disorder and depression diagnoistic codes."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

anx_cod_depr_cod_usage <- snomed_usage |> 
  mutate(
    depr_cod = snomed_code %in% depr_cod$code,
    anx_cod = snomed_code %in% anx_cod$code
    ) |> 
  pivot_longer(
    cols = c(depr_cod, anx_cod),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_depr_anx_cod_trends <- anx_cod_depr_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c("depr_cod", "anx_cod"), 
    labels = c("Depression diagnostic codes", "Anxiety diagnostic codes"))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.2) +
    geom_point() +
    labs(
      title = "Yearly counts of anxiety disorder and depression diagnoistic codes",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_colour_viridis_d(end = .8)

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_depr_anx_cod_trends.png"),
  fig_depr_anx_cod_trends,
  height = 4,
  width = 8
)

fig_depr_anx_cod_trends
```

# APM Survey 

In the [Adult Psychiatric Morbidity Survey: Survey of Mental Health and Wellbeing, England, 2023/4](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/methods) the following mental health conditions are assessed in [Chapter 1: Common mental health conditions](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/common-mental-health-conditions) and [Chapter 3: Posttraumatic stress disorder](https://digital.nhs.uk/data-and-information/publications/statistical/adult-psychiatric-morbidity-survey/survey-of-mental-health-and-wellbeing-england-2023-24/posttraumatic-stress-disorder) of the survey.

```{r}

condition_names <- list(
  gad = "Generalised anxiety disorder (GAD)",
  cmhc_nos = "Common mental health condition (NOS)",
  ocd = "Obsessive and compulsive disorder (OCD)",
  dep = "Depressive episode",
  pd = "Panic disorder",
  phobia = "Phobia",
  ptsd = "Posttraumatic stress disorder (PTSD)"
)

measures_mental_health_conditions <- list(
  gad = list(
    condition = "Generalised anxiety disorder (GAD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  cmhc_nos = list(
    condition = "Common mental health condition (CMHC) not otherwise specified (NOS)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ocd = list(
    condition = "Obsessive and compulsive disorder (OCD)",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  dep = list(
    condition = "Depressive episode",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  pd = list(
    condition = "Panic disorder",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  phobia = list(
    condition = "Phobia",
    diagnostic_status = "Present to diagnostic criteria",
    classification_system = "ICD-10",
    assessment_tool = "CIS-R",
    survey_phase = "1",
    reference_period = "Past week"
  ),
  ptsd = list(
    condition = "Posttraumatic stress disorder (PTSD)",
    diagnostic_status = "Screen positive",
    classification_system = "DSM-IV",
    assessment_tool = "PTSD Check List",
    survey_phase = "1",
    reference_period = "Past week"
  )
)

df_measures_mental_health_conditions <- map_dfr(measures_mental_health_conditions, ~.x, .id = "condition_tag")

gt(df_measures_mental_health_conditions) |> 
  cols_label(
    condition = "Condition",
    diagnostic_status = "Diagnostic status",
    classification_system = "Classification system",
    assessment_tool = "Assessment tool",
    survey_phase = "Survey phase",
    reference_period = "Reference period"
  ) |> 
  cols_hide(condition_tag)
```

## Search terms 

```{r}
#| label: define-search-terms
#| message: false
#| results: 'hide'
#| warning: false
#| echo: false

search_terms <- list(
  gad = c(
    "generalised anxiety",
    "generalized anxiety",
    "GAD",
    "anxiety disorder",
    "persistent anxiety",
    "excessive worry",
    "chronic anxiety"
  ),
  cmhc_nos = c(
    "mental disorder",
    "psychiatric disorder",
    "mental health condition",
    "psychological disorder",
    "behavioural disorder",
    "emotional disorder",
    "unspecified mental"
  ),
  ocd = c(
    "obsessive compulsive",
    "OCD",
    "obsession",
    "compulsion",
    "repetitive behaviour",
    "intrusive thought",
    "ritualistic behaviour"
  ),
  dep = c(
    "depression",
    "depressive episode",
    "major depression",
    "unipolar depression",
    "mood disorder",
    "depressive disorder",
    "melancholia",
    "dysthymia"
  ),
  pd = c(
    "panic disorder",
    "panic attack",
    "agoraphobia",
    "acute anxiety",
    "episodic anxiety"
  ),
  phobia = c(
    "phobia",
    "phobic disorder",
    "specific phobia",
    "social phobia",
    "agoraphobia",
    "fear disorder",
    "anxiety phobia"
  ),
  ptsd = c(
    "posttraumatic stress",
    "post-traumatic stress",
    "PTSD",
    "trauma disorder",
    "stress reaction",
    "acute stress",
    "combat stress",
    "post-trauma"
  )
)

# Create smaller dataframe with unique SNOMED CT code/description mapping
snomed_code_desc <- snomed_usage |> 
  select(end_date, snomed_code, description) |> 
  group_by(snomed_code) |> 
  arrange(desc(end_date), .by_group = TRUE) |> 
  mutate(description = first(description)) |> 
  ungroup() |> 
  arrange(desc(end_date), snomed_code) |> 
  select(-end_date) |> 
  distinct()

matching_codes_tibble <- find_matching_codes(snomed_code_desc, search_terms)

# matching_codes_tibble |> 
#   mutate(
#     semantic_tag = extract_semantic_tag(description),
#     description = strip_semantic_tag(description)
#   )

extract_codes_by_category <- function(matching_codes_tibble) {
  matching_codes_tibble |>
    group_by(search_category) |>
    summarise(codes = list(snomed_code)) |>
    deframe()
}

codes_by_category <- extract_codes_by_category(matching_codes_tibble)
# codes_by_category


add_category_flags <- function(data, codes_by_category) {
  existing_cols <- colnames(data)
  new_cols <- names(codes_by_category)
  conflicts <- intersect(existing_cols, new_cols)
  
  if (length(conflicts) > 0) {
    stop("Column names already exist in data: ", 
         str_c(conflicts, collapse = ", "))
  }

  df_with_category_flags <- data |>
    bind_cols(
      map_dfc(codes_by_category, ~data$snomed_code %in% .x) |>
        set_names(names(codes_by_category))
    )
  
  df_with_category_flags |>
    filter(if_any(all_of(new_cols))) |> 
    arrange(across(all_of(new_cols), desc), snomed_code, desc(start_date))
}

# snomed_usage |> 
#   add_category_flags(codes_by_category)
  

# search_summary_df <- create_search_summary_df(matching_codes_tibble, snomed_usage)
# search_summary_df <- search_summary_df |> 
#   mutate(search_category = recode(search_category, !!!condition_names))

# search_summary_table <- create_gt_table(search_summary_df)
# search_summary_table
```


```{r}
#| column: page
#| out-width: "100%"
#| warning: false

processed_matching_codes <- process_matching_codes(
  matching_codes_tibble,
  snomed_usage,
  condition_names,
  exclude_semantic_tags = c(
    "observable entity",
    "assessment scale",
    "regime/therapy",
    "procedure",
    "qualifier value",
    "physical object"
  )
)

interactive_table <- create_interactive_table_with_export(
  processed_matching_codes
)

interactive_table
```

## Total code usage

::: {.panel-tabset}

### GAD

Codelist draft:

```{r}
#| label: tab-gad-cod-counts
#| message: false
#| warning: false

"https://www.opencodelists.org/codelist/user/milanwiedemann/gad/1b8281dc"

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_depr_gad_usage.png")
  )

tab_depr_cod_counts
```

### CMHC NOS

Codelist draft:

```{r}
#| label: tab-cmhc-nos-cod-counts
#| message: false
#| warning: false

"https://www.opencodelists.org/codelist/user/milanwiedemann/cmhc-nos/02730ea7/"

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_cmhc_nos_cod_usage.png")
  )

tab_depr_cod_counts
```

### Depressive episode

Codelist draft:

```{r}
#| label: tab-dep-e-cod-counts
#| message: false
#| warning: false

"https://www.opencodelists.org/codelist/user/milanwiedemann/depre/5054283c/"

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_dep_e_cod_usage.png")
  )

tab_depr_cod_counts
```

### Panic disorder

Codelist draft:

```{r}
#| label: tab-pd-cod-counts
#| message: false
#| warning: false

"https://www.opencodelists.org/codelist/user/milanwiedemann/pd/3744b507/"

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_pd_cod_usage.png")
  )

tab_depr_cod_counts
```

### Phobia

Codelist draft:

```{r}
#| label: tab-cmh-phobia-cod-counts
#| message: false
#| warning: false

# In development here
"https://www.opencodelists.org/builder/1e3541d2/"

depr_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% depr_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_depr_cod_counts <- depr_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 depression diagnosis codes (`depr_cod`)"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_depr_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_phobia_cod_usage.png")
  )

tab_depr_cod_counts
```

### PTSD

Codelist draft:

```{r}
#| label: tab-cmh-ptsd-cod-counts
#| message: false
#| warning: false

ptsd_cod <- get_codelist(
  "https://www.opencodelists.org/codelist/opensafely/posttraumatic-stress-disorder-ptsd/168e7933/"
)

ptsd_cod_counts <- snomed_usage |> 
  filter(snomed_code %in% ptsd_cod$code) |> 
  get_semantic_tag() |> 
  summarise_code_counts() |> 
  slice_max(n = 20, order_by = usage)

# Display formatted table
tab_ptsd_cod_counts <- ptsd_cod_counts |>
  create_table_sem_tag(
    title = md("Top 15 PTSD diagnosis codes"),
    subtitle = "Timeframe: August 2011 to July 2024"
    )

gtsave(
  tab_ptsd_cod_counts,
  here("output", "tables", "cod_devel", "dx", "tab_ptsd_cod_usage.png")
  )

tab_ptsd_cod_counts
```

:::

## Trends over time

The below figure shows the coding of anxiety disorders and depression diagnoses, as specified in the NHS Primary Care Domain Refsets ([anx_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/anxiety-diagnostic-codes/20241205/), [depr_cod](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/depr_cod/20241205/)).


```{r}
#| label: all-cod-trends-
#| fig-cap: "Yearly counts of diagnoistic codes."
#| fig-height: 4.5
#| fig-width: 8
#| warning: false

all_cod_usage <- snomed_usage |> 
  mutate(
    ptsd_cod = snomed_code %in% ptsd_cod$code,
    anx_cod = snomed_code %in% anx_cod$code
    ) |> 
  pivot_longer(
    cols = c(ptsd_cod, anx_cod),
    names_to = "codelist") |> 
  filter(value == TRUE) |> 
  group_by(end_date, codelist) |> 
  summarise(count = sum(usage, na.rm = TRUE))

fig_all_cod_trends <- all_cod_usage |> 
  mutate(codelist = factor(
    codelist,
    levels = c("ptsd_cod", "anx_cod"), 
    labels = c("PTSD", "Anxiety"))) |> 
  ggplot(
      aes(
        y = count,
        x = end_date,
        colour = codelist,
        shape = codelist
      )
    ) +
    geom_line(alpha = 0.2) +
    geom_point() +
    labs(
      title = "Yearly counts of anxiety disorder and depression diagnoistic codes",
      x = NULL,
      y = NULL,
      colour = NULL,
      shape = NULL,
      caption = "Data from NHS England SNOMED Code Usage in Primary Care."
    ) +
    scale_x_date(
      date_breaks = "1 year",
      labels = label_date_short()
    ) +
    scale_y_continuous(
      labels = label_number(accuracy = 1),
      limits = c(0, NA)
    ) +
    theme_bw() +
    theme(legend.position = "bottom") +
    scale_colour_viridis_d(end = .8)

ggsave(
  filename = here("output", "figures", "cod_devel", "dx", "fig_depr_anx_cod_trends.png"),
  fig_depr_anx_cod_trends,
  height = 4,
  width = 8
)

fig_all_cod_trends
```