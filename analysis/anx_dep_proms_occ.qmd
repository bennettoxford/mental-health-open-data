---
title: "Extracting SNOMED CT semantic tags from descriptions (PROMs)"
format: html
editor: source
---

```{r setup}
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true

library(opencodecounts) 
library(tidyverse) 
library(gt) 
library(scales)

```

**Note:** All searches use `tolower()` on both SNOMED CT descriptions and search terms to handle inconsistent spelling and capitalisation (e.g., UK vs US spellings). This improved match rates and helped uncover valid codes that would otherwise be missed.

# Worked example

```{r extracting tags}

# Filter data
phq_codes_usage <- snomed_usage |> 
  filter(str_detect(tolower(description), tolower("Patient Health Questionnaire")))

# Extract semantic tag and add new variable
phq_codes_usage_semantic_tag <- phq_codes_usage |> 
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

```

```{r phq-table}
# Calculate total code usage for entire period
tab_phq_code_counts <- phq_codes_usage_semantic_tag |> 
  group_by(snomed_code, description_short, semantic_tag) |> 
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Create table grouped by semantic_tag
tab_phq_code_counts |> 
  group_by(semantic_tag) |> 
  gt() |> 
    fmt_percent(
      columns = c(ratio_usage),
      decimals = 3
  )

```

```{r phq-plot}
# Create plot with facets using facet_wrap()
ggplot(phq_codes_usage_semantic_tag, 
  aes(
    y = usage, 
    x = end_date,
    colour = description
    )) + 
  geom_line(alpha = 0.2) + 
  geom_point() +
  labs(
    title = "Yearly counts of codes with the term 'Patient Health Questionnaire' in their description",
    x = NULL,
    y = NULL,
    colour = NULL,
    caption = "Data from NHS England SNOMED Code Usage in Primary Care.") + 
  scale_x_date(
    date_breaks = "1 year",
    labels = label_date_short()) +
  scale_y_continuous(
    labels = label_number(),
    limits = c(0, NA)
    ) +
  facet_wrap(~semantic_tag, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(colour = guide_legend(ncol = 2, byrow = TRUE))
```

```{r phq-bar-plot}

ggplot(phq_codes_usage_semantic_tag, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title("patient health questionnaire")),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretations

PHQ-9 score dominates usage, making up over 90% of all codes. This reflects its historic inclusion in QOF around 2014, as mentioned by Jamie (GP), which likely standardised its recording. Although the QOF incentive no longer applies, PHQ-9 continues to be widely used.

PHQ-2 is the second most common code and has shown increasing usage since 2020. While its uptake remains low in absolute terms, the trend suggests growing interest in brief screening tools.

All other codes,including PHQ-4, PHQ-15, and screening variants, remain rarely used. Overall, coding activity is increasing across most PHQ-related codes, possibly due to greater mental health demand post-pandemic.

Observable entity is the most common semantic tag. 14 phq SNOMED CT codes

## Beck Anxiety Inventory - SNOMED CT code usage

```{r beck anx}
# Set PROM search term
search_term <- "Beck Anxiety"

# Filter SNOMED usage data
bai_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
    )
# Create usage summary table
bai_summary <- bai_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
bai_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r beck-anx-plot}
# Plot usage over time
ggplot(bai_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r bai-bar-plot}
ggplot(bai_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

Overall usage of BAI-related codes is low compared to other PROMs. Three distinct codes were identified: two classified as assessment scale and one as observable entity. The observable entity code — Beck Anxiety Inventory score — has seen a notable increase in use since 2020, while the assessment scale codes show inconsistent usage patterns across the past decade.

This shift suggests a possible move toward recording standardised scores, but without any clear national incentive or policy, uptake remains limited.

3 SNOMED CT codes

## Beck Depression Inventory - SNOMED CT code usage

```{r beck dep}
# Set PROM search term
search_term <- "Beck Depression"

# Filter SNOMED usage data
bdi_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
bdi_summary <- bdi_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
bdi_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r bdi-plot}
# Plot usage over time
ggplot(bdi_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r bdi-bar-plot}
ggplot(bdi_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

The Beck Depression Inventory (BDI) is most frequently recorded using observable entity codes. These account for over 95% of total usage, with the majority from the BDI-II score. However, usage has steadily declined since a sharp drop around 2015.

Assessment scale codes are used inconsistently, with fewer than 1,000 instances each. Procedure codes appear only in the last five years. These include both the original and revised versions of the BDI, but usage remains low. The original version declined during the COVID period and was not recorded after 2023. The revised version shows consistently low use.

Overall, this suggests that while BDI-II was once widely used, its use has declined. This may reflect changing clinical preferences, updated guidance, or a shift toward other PROMs such as the PHQ-9.

5 SNOMED CT codes

## GAD 2&7- SNOMED CT code usage

```{r gad}
# Set PROM search term
search_term_1 <- "Generalized Anxiety Disorder"
search_term_2 <- "Generalised anxiety disorder"

# Filter SNOMED usage data
gad7_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term_1)) | str_detect(tolower(description), tolower(search_term_2))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )
  
# Create usage summary table
gad7_summary <- gad7_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
gad7_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r gad-plot}
# Plot usage over time
ggplot(gad7_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term_1)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r gad-bar-plot}

ggplot(gad7_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term_1)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()

```

### Results and Interpretation

SNOMED CT codes for Generalized Anxiety Disorder (GAD) varied by spelling and semantic tag. The most used terms were “GAD-7 7 item score” (observable entity), accounting for over 5 million records. Disorder-level codes and assessment variants were also present, though used less consistently.

The bar plot shows a clear preference for observable entity codes. Trends over time reveal growing use of structured codes post-2020, while usage of assessment scale terms peaked in 2019 and declined. Procedure- and situation-tagged codes remained rare.

These patterns suggest widespread uptake of GAD PROMs but inconsistent coding practices, with observable entities emerging as the standard.

## Whooley Questions - SNOMED CT code usage

```{r whooley}
# Set PROM search term
search_term <- "Whooley"

# Filter SNOMED usage data
whooley_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
whooley_summary <- whooley_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
whooley_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r whooley-plot}
# Plot usage over time
ggplot(whooley_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r whooley-bar-plot}
ggplot(whooley_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

Usage is dominated by a single procedure code, “Assessment using Whooley depression screen”, which accounts for nearly all recorded activity. In contrast, the assessment scale and observable entity codes are used far less frequently.

From 2019 onward, the observable entity code (screen score) has seen consistent annual growth, while the procedure code exhibits the highest absolute usage and a generally increasing trend since 2016. The assessment scale shows a modest peak in 2020 followed by a gradual decline.

This pattern suggests a strong preference for coding Whooley assessments as procedures in primary care, with increasing uptake of recording scores separately in recent years. The assessment scale appears underused or possibly deprecated. Usage of Whooley-related codes is far lower than for PHQ-9 or GAD-7, aligning with GP feedback that the tool is rarely used in practice. Nearly all activity is recorded as a procedure, with minimal use of the assessment scale or score. This may reflect limited clinical adoption or awareness.

## Mobility Inventory - SNOMED CT code usage

```{r mi}
# Set PROM search term
search_term <- "Mobility Inventory"

# Filter SNOMED usage data
mi_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
mi_summary <- mi_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
mi_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r mi plot}
# Plot usage over time
ggplot(mi_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r mi-bar-plot}
ggplot(mi_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

All three codes show extremely low usage (\<65 times each). Temporal trends are flat or negligible, with a small recent uptick for “when alone” scores. This suggests that the PROM is rarely used in primary care.

## Social Phobia Inventory - SNOMED CT code usage

```{r soc pho}
# Set PROM search term
search_term <- "Social Phobia Inventory"

# Filter SNOMED usage data
spi_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
spi_summary <- spi_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
spi_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r spi-plot}
# Plot usage over time
ggplot(spi_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r spi-bar-plot}

ggplot(spi_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()

```

### Results and Interpretation

Three codes were identified: an assessment scale, a procedure, and an observable entity. The observable entity ("Social phobia inventory score") accounted for the majority of usage, exceeding 1,400 records. The assessment scale and procedure codes were used far less frequently, each under 300 uses.

Usage trends showed an early peak in assessment scale usage (2018–2019) followed by a decline. In contrast, the observable entity rose steadily, with a marked increase from 2020 onwards. The procedure code remained static with negligible usage. This suggests a shift in coding preference rather than clinical behaviour.

## Chalder Fatigue Questionnaire - SNOMED CT code usage

```{r chalder}
# Set PROM search term
search_term <- "Chalder Fatigue"

# Filter SNOMED usage data
cfq_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
cfq_summary <- cfq_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
cfq_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r cfq-plot}
# Plot usage over time
ggplot(cfq_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r cfq-bar-plot}
ggplot(cfq_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

Code usage was concentrated in one observable entity (score) code (n ≈ 500), with minimal use of the assessment scale term (n = 5). The score code showed a consistent upward trend from 2021 to 2024, suggesting increasing recording in primary care. The assessment scale term remained rarely used.

## Francis Irritable Bowel - SNOMED CT code usage - zero results

```{r fib}
# Set PROM search term
search_term <- "Francis Irritable Bowel"

# Filter SNOMED usage data
fib_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
fib_summary <- fib_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
if (nrow(fib_usage) > 0) {
  fib_summary |> 
    group_by(semantic_tag) |> 
    gt() |> 
    fmt_percent(columns = ratio_usage, decimals = 3)
} else {
  cat("No codes to summarise.")
}
```

```{r fib-plot}
# Plot usage over time
if (nrow(fib_usage) > 0) {
  ggplot(fib_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
  } else {
  cat("No usage data found for this PROM.")
    }
```

### Results and Interpretation

No SNOMED CT code usage was identified for the Francis Irritable Bowel PROM, suggesting it is not currently used or recorded in NHS England primary care datasets.

## Obsessive Compulsive Inventory - SNOMED CT code usage

```{r oci}
# Set PROM search term
search_term <- "Obsessive Compulsive Inventory"

# Filter SNOMED usage data
oci_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
oci_summary <- oci_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
oci_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r oci-plot}
# Plot usage over time
ggplot(oci_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r oci-bar-plot}
ggplot(oci_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

Total usage shows higher recording of scores (observable entity) compared to the assessment scale itself. Temporal trends show steadily increasing usage of score codes in recent years, while assessment scale usage peaked around 2017 and declined thereafter. This suggests a preference for recording outcomes rather than referencing the assessment tool directly

## Postpartum Depression Screening - SNOMED CT code usage

```{r pds}
# Set PROM search term
search_term <- "Postpartum Depression Screening"

# Filter SNOMED usage data
pds_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
pds_summary <- pds_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
pds_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r pds-plot}
# Plot usage over time
ggplot(pds_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r pds-bar-plot}
ggplot(pds_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

Usage was extremely low, with only five records observed in each of the past three years. This suggests the PROM is rarely used in routine primary care documentation

## Hamilton Depression Scale - SNOMED CT code usage - no results

```{r hds}
# Set PROM search term
search_term <- "Hamilton Depression"

# Filter SNOMED usage data
hds_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
hds_summary <- hds_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
# if (nrow(prom_usage) > 0) {
#   hds_summary |> 
#     group_by(semantic_tag) |> 
#     gt() |> 
#     fmt_percent(columns = ratio_usage, decimals = 3)
# } else {
#   cat("No codes to summarise.")
# }
```

```{r hds-plot}
# Plot usage over time
if (nrow(hds_usage) > 0) {
  ggplot(hds_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
  } else {
  cat("No usage data found for this PROM.")
    }
```

### Results and Interpretation

No SNOMED CT code usage was identified for the Hamiltion Depression Scale PROM, suggesting it is not currently used or recorded in NHS England primary care datasets.

## Hospital Anxiety and Depression Scale - SNOMED CT code usage

```{r hads}
# Set PROM search term
search_term <- "Hospital Anxiety and Depression Scale"

# Filter SNOMED usage data
hads_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
hads_summary <- hads_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
hads_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r hads-plot}
# Plot usage over time
ggplot(hads_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r hads-bar-plot}
ggplot(hads_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()
```

### Results and Interpretation

HADS scores for anxiety and depression (observable entities) are widely used in primary care, each exceeding 700,000 uses by 2023. Usage has steadily increased since 2018. In contrast, the original assessment scale and declined/refusal codes were rarely used. Documentation clearly favours score-level entries.

## Geriatric Depression Scale - SNOMED CT code usage

```{r gds}
# Set PROM search term
search_term <- "Geriatric depression scale"

# Filter SNOMED usage data
gds_usage <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(search_term))) |>
  mutate(
    description_short = str_remove(description, " \\([^()]+\\)$"),
    semantic_tag = str_extract(description, "\\(([^()]+)\\)$"),
    semantic_tag = str_replace_all(semantic_tag, "[()]", "")
  )

# Create usage summary table
gds_summary <- gds_usage |>
  group_by(snomed_code, description_short, semantic_tag) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)

# Display formatted table
gds_summary |>
  group_by(semantic_tag) |>
  gt() |>
  fmt_percent(columns = ratio_usage, decimals = 3)
```

```{r gds-plot}
# Plot usage over time
ggplot(gds_usage, aes(x = end_date, y = usage, colour = description)) +
  geom_line(alpha = 0.3) +
  geom_point() +
  facet_wrap(~semantic_tag, scales = "free_y") +
  labs(
    title = paste0("Usage Trends: ", str_to_title(search_term)),
    x = NULL,
    y = "Usage Count",
    caption = "Data source: NHS England SNOMED Usage in Primary Care"
  ) +
  scale_x_date(date_breaks = "1 year", labels = label_date_short()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r gds-bar-plot}
ggplot(gds_usage, aes(
  x = fct_reorder(description_short, usage),
  y = usage,
  fill = semantic_tag
)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  labs(
    title = paste0("Code usage for ", str_to_title(search_term)),
    x = NULL,
    y = "Total Usage",
    fill = "Semantic Tag"
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_minimal()

```

### Results and Interpretation

The main assessment scale code for GDS saw high use between 2012–2020, peaking in 2017 (\~9,000 uses), then declining sharply to under 500 annually post-2021. Recent usage shifted to observable entity codes (short form, long form, 4-item), but these remain rare (\<125/year). Procedure and additional assessment codes were also minimally used. Overall, GDS use has declined, with newer formats seeing limited uptake.

## Summary of SNOMED Usage for PROMs in Primary Care

PHQ-9 and GAD-7 are the most widely used PROMs for depression and anxiety, with consistently high usage counts and widespread adoption of their score-level SNOMED codes.

HADS (Hospital Anxiety and Depression Scale) shows strong usage for both anxiety and depression scores (observable entities), with steady growth since 2018. Assessment-scale codes are rarely used.

Whooley Questions show minimal usage overall and are not routinely recorded in SNOMED, consistent with GP feedback.

Postpartum Depression Screening (e.g., EPDS) appears in SNOMED but is recorded extremely rarely, with only 5 uses per year, suggesting limited structured capture in primary care.

Geriatric Depression Scale (GDS) was historically used more frequently (peaking in 2017), but usage has declined sharply post-2020. Observable entity codes for GDS variants (short/long/4-item forms) are now used occasionally but remain rare.

Francis Irritable Bowel PROM and similar instruments (e.g., condition-specific tools outside mental health) show zero usage, indicating they are not part of routine structured primary care recording.