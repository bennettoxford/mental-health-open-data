---
title: "Check for Missing PROMs Codes"
format: html
editor: source
---

After doing the semantic tag search, it is important to ensure no PROMS related codes are missing from the final codelist.

The aim of this document is to check which codes were found in the search that are not in the current draft of the codelist.

### Set up

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true

library(opencodecounts)
library(tidyverse)
library(gt)
library(scales)
library(stringr)


```

### PROMs-related search list

This list includes all the search terms from analysis/anx_dep_proms/anx_dep_proms_occ.qmd within additions (e.g., depression screening, depression scale).

-   Removed "beck" and "gad" from the search terms list because the results were unrelated to anxiety/depression PROMs

```{r}

#PROMS related search term list
search_terms <- c("Patient Health Questionnaire", "Beck Anxiety", "Beck Depression","Generalized Anxiety Disorder", "Generalised anxiety disorder", "Whooley", "Mobility Inventory", "Social Phobia Inventory", "Chalder Fatigue", "Obsessive Compulsive Inventory","Irritable Bowel Syndrome - Symptom Severity Scale" ,"Postpartum Depression Screening","postnatal depression scale", "Hospital Anxiety and Depression Scale","Hamilton rating scale", "Body Image Questionnaire","Panic disorder severity scale", "Post-traumatic stress disorder checklist",  "Geriatric depression scale", "depression screening", "anxiety screening", "depression scale", "anxiety scale")

```

```{r}
#filter snomed_usage by search terms list
all_proms <- snomed_usage |>
  filter(str_detect(tolower(description), tolower(paste(search_terms, collapse = "|"))))

#summarise code usage, grouping by code and description
all_proms_summary <- all_proms |>
  group_by(snomed_code, description) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage)) |>
  arrange(-usage)
```

### Existing codelist

```{r}
#Load and filter existing codelist
existing_codelist <- get_codelist("user/Lola_O/patient-reported-outcome-measures-anxiety-and-depression/62411c0f")

codelist_usage <- snomed_usage |>
  filter(snomed_code %in% existing_codelist$code)

```

### Find codes in codelist not found in search

```{r}
extra_codes_summary <- codelist_usage |>
  filter(!snomed_code %in% all_proms_summary$snomed_code) |>
  group_by(snomed_code, description) |>
  summarise(usage = sum(usage), .groups = "drop") |>
  mutate(ratio_usage = usage / sum(usage))

extra_codes_summary |>
  gt() |>
    fmt_percent(
      columns = ratio_usage,
      decimals = 3
    )



```

These codes are non-NICE recommended PROMs found in search on opencodelists.

### Find codes from search not yet in codelist

```{r}
missing_codes_from_search <- all_proms_summary |>
  filter(!snomed_code %in% codelist_usage$snomed_code)

missing_codes_from_search |>
  gt() |>
    fmt_percent(
      columns = ratio_usage,
      decimals = 3
    )
  
  

```

## Summary

PROMs like PHQ-2, PHQ-4, GAD-2 and their related codes have been added to the codelist already.

Captured codes which need to be added to codelist:

-   Edinburgh postnatal depression scale screening offered (situation)

-   Zung's self-rating anxiety scale

-   Chalder Fatigue Scale (assessment scale)

-   Chalder Fatigue Scale score (observable entity)

-   Beck anxiety standardized rating scale (assessment scale)

-   Obsessive compulsive inventory (assessment scale)

-   Irritable Bowel Syndrome - Symptom Severity Scale (assessment scale)

-   Irritable Bowel Syndrome - Symptom Severity Scale score (observable entity)

> The GAD disorder code will not be added to the code list since it is a diagnosis code, out of scope.

> Initially exclude all child and children related codes as focus on code usage for PROMs for adult anxiety and depression
