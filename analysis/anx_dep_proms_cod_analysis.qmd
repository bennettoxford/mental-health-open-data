---
title: "Codelist analysis for PROMs for anxiety disorders and depression"
toc: true
toc-depth: 2
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    other-links:
      - text: opencodecounts R pkg
        href: https://bennettoxford.github.io/opencodecounts/
      - text: SNOMED Code Usage
        href: https://digital.nhs.uk/data-and-information/publications/statistical/mi-snomed-code-usage-in-primary-care
editor: source
---

```{r}
#| label: setup
#| message: false
#| results: 'hide'
#| warning: false
#| echo: true
#| cache: true

library(opencodecounts)
library(tidyverse)
library(gt)
library(scales)
library(here)
library(patchwork)

source(here("lib", "fun_tables.R"))
source(here("lib", "fun_data.R"))
source(here("lib", "fun_figures.R"))

# Load codelists
proms_anx_cod <- get_codelist(
  "user/Lola_O/patient-reported-outcome-measures-for-anxiety-disorders/387cdfd9/"
)

proms_dep_cod <- get_codelist(
  "user/Lola_O/patient-reported-outcome-measures-for-depression/2ceb2c72/"
)

# Get data for both codelists and extract semantic tag
proms_anx_dep_usage <- snomed_usage |>
  filter(snomed_code %in% c(proms_anx_cod$code, proms_dep_cod$code)) |>
  mutate(
    semantic_tag = extract_semantic_tag(description),
    description_short = strip_semantic_tag(description),
    proms_anx_cod = snomed_code %in% proms_anx_cod$code,
    proms_dep_cod = snomed_code %in% proms_dep_cod$code
  ) |>
  select(
    start_date,
    end_date,
    snomed_code,
    description,
    usage,
    description_short,
    semantic_tag,
    proms_anx_cod,
    proms_dep_cod
  )

# Use the most recent description for all codes
proms_anx_dep_usage <- proms_anx_dep_usage |>
  group_by(snomed_code) %>%
  arrange(desc(end_date), .by_group = TRUE) %>%
  mutate(description_short = first(description_short)) %>%
  ungroup() |> 
  arrange(desc(end_date), snomed_code)
```

# Overview

- TODO: Add short overivew

# Methods

- TODO: Add short methods

# Analysis

- TODO: Add short description of analysis

## Table

```{r}
#| label: tab-top5-proms-anx-dep
#| echo: false
#| message: false
#| warning: false

top5_proms_anx_dep_usage <- proms_anx_dep_usage |> 
  group_by(snomed_code) |> 
  mutate(total_usage = sum(usage)) |> 
  select(
    snomed_code, description_short, semantic_tag, proms_anx_cod, proms_dep_cod,
    total_usage
    ) |> 
  distinct(snomed_code, .keep_all = TRUE) |> 
  ungroup() |> 
  pivot_longer(
    cols = c("proms_anx_cod", "proms_dep_cod"),
    names_to = "codelist") |>
  filter(value == TRUE) |> 
  group_by(codelist) |> 
  mutate(ratio_usage = total_usage / sum(total_usage)) |> 
  slice_max(order_by = total_usage, n = 5)

description_dict <- c(
  "Generalized Anxiety Disorder 7 item score" = "GAD-7 score",
  "Generalized anxiety disorder 7 item score" = "GAD-7 score", 
  "Generalised anxiety disorder 2 scale score" = "GAD-2 score",
  "Generalised anxiety disorder 2 scale" = "GAD-2 assessment",
  "Hospital Anxiety and Depression scale: anxiety score" = "HADS anxiety score ",
  "Hospital Anxiety and Depression scale: depression score" = "HADS depression score",
  "Patient Health Questionnaire Nine Item score" = "PHQ-9 score",
  "Edinburgh postnatal depression scale score" = "EPDS score",
  "Assessment using Whooley depression screen" = "Whooley depression screening",
  "Edinburgh postnatal depression scale" = "EPDS assessment",
  "Depression screening using questions" = "Depression screening"
)

tab_top5_proms_anx_dep_usage <- top5_proms_anx_dep_usage |> 
  select(-value) |> 
  mutate(
    semantic_tag = str_to_sentence(semantic_tag),
    description_short = recode(description_short, !!!description_dict),
    codelist = factor(
      codelist,
      levels = c("proms_anx_cod", "proms_dep_cod"),
      labels = c("Anxiety disorders", "Depression"))
    ) |> 
  gt() |>
    cols_label(
      snomed_code = "SNOMED code",
      description_short = "Description",
      semantic_tag = "Semantic tag",
      total_usage = "Usage",
      ratio_usage = "%"
    ) |>
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_column_labels(columns = everything())
    ) |>
    cols_align(
      align = "left",
      columns = snomed_code
    ) |>
    tab_style(
      style = list(
        cell_text(font = "Courier New")
      ),
      locations = cells_body(columns = snomed_code)
    ) |>
    fmt_number(total_usage, decimals = 0) |> 
    fmt_percent(
      columns = c(ratio_usage),
      decimals = 1
    ) |>
  tab_footnote(
    footnote = "GAD = Generalized Anxiety Disorder; HADS = Hospital Anxiety and Depression scale; PHQ = Patient Health Questionnaire; EPDS = Edinburgh postnatal depression scale.",
    locations = cells_column_labels(columns = description_short)
  ) |>
  tab_footnote(
    footnote = "Percentage usage of PROMs anxiety disorders and depression separately.",
    locations = cells_column_labels(columns = ratio_usage)
  )

gtsave(
  tab_top5_proms_anx_dep_usage,
  here("output", "tables", "cod_analysis", "proms", "tab_top5_proms_usage.png")
  )

tab_top5_proms_anx_dep_usage
```
